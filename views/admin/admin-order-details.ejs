<%- include("../../views/partials/admin/header") %>

<div class="content-header row">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="content-title card-title">Order Details</h2>
    <a href="/admin/orders" class="btn btn-secondary">Back to Orders</a>
    
  </div>
</div>

<div class="card p-4 mb-4">
  <h5><strong>Order ID:</strong> <%= order._id %></h5>
  <p><strong>Order Date:</strong> <%= new Date(order.createdOn).toLocaleString() %></p>

  <hr />

  <h5>User Details</h5>
  <p><strong>Name:</strong> <%= order.user?.name || 'N/A' %></p>
  <p><strong>Email:</strong> <%= order.user?.email || 'N/A' %></p>
  <p><strong>Phone:</strong> <%= order.user?.phone || 'N/A' %></p>

  <hr />

  <h5>Ordered Items</h5>
  <table class="table table-striped">
    <thead>
      <tr>
        <th>Product</th>
        <th>Quantity</th>
        <th>Price</th>
        <th>Subtotal</th>
        <th>Status</th>
        
      </tr>
    </thead>
    <tbody>
<% order.orderedItems.forEach(item => { %>
  <tr>
    <td><%= item.product?.productName || 'Product info missing' %></td>
    <td><%= item.quantity %></td>
    <td>£<%= item.price.toFixed(2) %></td>
    <td>£ <%= (item.price * item.quantity).toFixed(2) %></td>
    <td>
      <% if (order.returnStatus === 'Return Requested' || order.returnStatus === 'Returned') { %>
        <%= order.returnStatus %>
      <% } else { %>
        <%= order.status %>
      <% } %>
    </td>
  </tr>
<% }) %>

    </tbody>
  </table>
  

  <hr />



  <h5>Total Amount: £ <%= order.finalAmount.toFixed(2) %></h5>


  <hr />
    <% if (order.returnStatus === 'Return Requested' && order.returnReason) { %>
  <div class="alert alert-warning mt-3">
    <strong>Return Reason:</strong> <%= order.returnReason %>
  </div>
<% } %>


  <!-- Status update form -->
   <% if (order.returnStatus === 'Return Requested') { %>
  <form method="POST" action="/admin/orders/<%= order._id %>/verify-return">
    <button type="submit" class="btn btn-success">Verify Return & Refund Wallet</button>
  </form>
<% } else if (order.returnStatus === 'Returned') { %>
  <p class="text-success">Return Verified. Refunded to wallet.</p>
<% } %>



  <form action="/admin/orders/<%= order._id %>/status" method="POST" class="mt-4">
    <div class="mb-3">
      <label for="status" class="form-label"><strong>Change Order Status</strong></label>
      <select name="status" id="status" class="form-select" required>
        <% const statuses = ['Pending', 'Shipped', 'Out for delivery', 'Delivered', 'Cancelled']; %>
        <% statuses.forEach(s => { %>
          <option value="<%= s %>" <%= order.status === s ? 'selected' : '' %>><%= s.charAt(0).toUpperCase() + s.slice(1) %></option>
        <% }) %>
      </select>
    </div>
    <button type="submit" class="btn btn-primary">Update Status</button>
  </form>
  
  
</div>

<%- include("../../views/partials/admin/footer") %>

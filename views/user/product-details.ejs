<%- include("../../views/partials/user/header") %>

<style>
  .breadcrumb {
    margin-top: 150px;
    font-weight: bold;
    color: #333;
  }

  .breadcrumb a {
    color: #3bcf0d;
    text-decoration: none;
    margin-right: 5px;
  }
  .breadcrumb a:hover {
    text-decoration: underline;
  }

  .product-details-container {
    display: flex;
    flex-wrap: wrap;
    gap: 40px;
    max-width: 1000px;
    margin: 80px auto 20px;
  }

  .image-zoom-container {
    position: relative;
    width: 400px;
    height: 400px;
    overflow: hidden;
    border-radius: 8px;
    border: 1px solid #ddd;
    cursor: zoom-in;
  }

  .image-zoom-container img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    transition: transform 0.3s ease;
  }

  .image-zoom-container.zoomed {
    overflow: auto;
    cursor: zoom-out;
  }

  .image-zoom-container.zoomed img {
    transform: scale(2);
  }

  .product-info {
    flex: 1;
    min-width: 300px;
  }

  .product-name {
    font-size: 28px;
    font-weight: bold;
    margin-bottom: 8px;
  }

  .rating {
    color: #f2b01e;
    margin-bottom: 12px;
  }

  .price-section {
    margin: 15px 0;
    font-size: 22px;
  }

  .original-price {
    text-decoration: line-through;
    color: #888;
    margin-left: 12px;
    font-size: 18px;
  }

  .discount-badge {
    background-color: #e63946;
    color: white;
    padding: 3px 8px;
    border-radius: 5px;
    font-size: 14px;
    margin-left: 10px;
  }

  .coupon-info {
    margin-top: 8px;
    background-color: #d1e7dd;
    padding: 8px;
    border-radius: 5px;
    color: #0f5132;
    font-size: 14px;
  }

  .stock-status {
    margin: 20px 0;
    font-weight: bold;
  }

  .stock-available {
    color: green;
  }

  .stock-unavailable {
    color: red;
  }

  .add-to-cart-btn {
    background-color: #3bcf0d;
    color: white;
    padding: 12px 20px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 16px;
  }

  .add-to-cart-btn:disabled {
    background-color: #999;
    cursor: not-allowed;
  }

  .reviews-section {
    margin-top: 40px;
  }

  .review {
    border-bottom: 1px solid #ddd;
    padding: 10px 0;
  }

  .review .review-rating {
    color: #f2b01e;
  }

  .review .review-comment {
    margin-top: 5px;
    font-style: italic;
  }

  @media (max-width: 768px) {
    .product-details-container {
      flex-direction: column;
      align-items: center;
    }

    .image-zoom-container {
      width: 90%;
      height: auto;
      max-width: 400px;
    }

    .product-info {
      width: 90%;
    }
  }
</style>

<!-- Breadcrumbs -->
<nav class="breadcrumb" aria-label="breadcrumb">
  <a href="/shop">Shop</a> &gt;

  <% if (product.category && product.category.name) { %>
    <a href="/shop?category=<%= product.category.name %>">
      <%= product.category.name.charAt(0).toUpperCase() + product.category.name.slice(1) %>
    </a> &gt;
  <% } else { %>
    <span>Unknown Category</span> &gt;
  <% } %>

  <span><%= product.productName %></span>
</nav>

<div class="main-container">
  <div class="product-details-container">
    <!-- Image Zoom Container -->
    <div class="image-zoom-container" id="imageZoomContainer">
      <% 
        const cleanFileName = product.productImage[0].split('\\').pop().split('/').pop();
      %>
      <img src="/uploads/products/<%= cleanFileName %>" alt="<%= product.productName %>" />
    </div>

    <!-- Product Info -->
    <div class="product-info">
      <h1 class="product-name"><%= product.productName %></h1>

      <!-- Ratings -->
      <div class="rating" aria-label="Product rating">
        <% 
          const fullStars = Math.floor(product.rating);
          const halfStar = product.rating % 1 >= 0.5;
          const emptyStars = 5 - fullStars - (halfStar ? 1 : 0);
        %>
        <% for(let i=0; i<fullStars; i++) { %>⭐<% } %>
        <% if(halfStar) { %>✰<% } %>
        <% for(let i=0; i<emptyStars; i++) { %>☆<% } %>
        <span>(<%= product.ratingCount || 0 %> reviews)</span>
      </div>

      <!-- Price & Discount -->
      <div class="price-section">
        <span class="discounted-price">£<%= product.price.toFixed(2) %></span>
        
        <% if (product.discount && product.discount > 0) { 
          const originalPrice = (product.price * 100) / (100 - product.discount); 
        %>
          <span class="original-price">£<%= originalPrice.toFixed(2) %></span>
          <span class="discount-badge"><%= product.discount %>% OFF</span>
        <% } %>
      </div>

      <!-- Coupon info -->
      <% if(product.coupon) { %>
        <div class="coupon-info">
          Coupon Applied: <strong><%= product.coupon.code %></strong> - <%= product.coupon.description %>
        </div>
      <% } %>

      <!-- Stock Status -->
      <div class="stock-status <%= product.stock > 0 ? 'stock-available' : 'stock-unavailable' %>">
        <% if(product.stock > 10) { %>
          In Stock
        <% } else if(product.stock > 0) { %>
          Only <%= product.stock %> left in stock - hurry up!
        <% } else { %>
          <strong>Sold Out / Out of Stock</strong>
        <% } %>
      </div>

      <!-- Add to Cart -->
      <button 
        class="add-to-cart-btn" 
        <%= product.stock === 0 ? 'disabled' : '' %>
        onclick="addToCart('<%= product._id %>')"
      >
        Add to Cart
      </button>

      <!-- Description -->
      <div class="description" style="margin-top: 20px;">
        <h3>Description</h3>
        <p><%= product.description || 'No description available.' %></p>
      </div>

      <!-- Highlights -->
      <% if (product.highlights && product.highlights.length > 0) { %>
        <div class="highlights" style="margin-top: 20px;">
          <h3>Highlights</h3>
          <ul style="display: flex; flex-wrap: wrap; gap: 20px; list-style-type: disc; padding-left: 20px;">
            <% product.highlights.forEach(item => { %>
              <li style="margin: 0;"><%= item %></li>
            <% }) %>
          </ul>
        </div>
      <% } %>
    </div>
  </div>

<% if (relatedProducts && relatedProducts.length > 0) { %>
  <div class="related-products" style="margin-top: 40px;">
    <h3>Related Product Recommendations</h3>
    <div style="display: flex; flex-wrap: nowrap; overflow-x: auto; gap: 20px; padding: 10px 0;">
      <% relatedProducts.forEach(p => { 
        const cleanFileName = p.productImage[0].split('\\').pop().split('/').pop();
      %>
        <div style="flex: 0 0 180px; max-width: 180px; border: 1px solid #ccc; border-radius: 8px; padding: 10px; background-color: white;">
          <a href="/product-details?id=<%= p._id %>" style="text-decoration: none; color: inherit;">
            <img src="/uploads/products/<%= cleanFileName %>" alt="<%= p.productName %>" style="width: 100%; height: auto; object-fit: contain; border-radius: 4px;">
            <h5 style="margin: 10px 0 5px; font-size: 16px;"><%= p.productName %></h5>
            <p style="font-weight: bold;">£<%= p.price.toFixed(2) %></p>
          </a>
        </div>
      <% }) %>
    </div>
  </div>
<% } %>

</div>

<script>
  const imageZoomContainer = document.getElementById('imageZoomContainer');
  imageZoomContainer.addEventListener('click', () => {
    imageZoomContainer.classList.toggle('zoomed');
  });

  function addToCart(productId) {
    alert('Added product ' + productId + ' to cart!');
  }
</script>

<%- include("../../views/partials/user/footer") %>

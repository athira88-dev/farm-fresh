<%- include("../../views/partials/user/header") %>

<style>
  /* Keep your existing styles here */
  .main-container {
  max-width: 1200px;
  margin: 150px auto 0; /* Add top margin to prevent overlap */
  padding: 20px;
  }
  .product-list-container {
    display: flex;
    gap: 20px;
  }
  .filter-sidebar {
  width: 20%;
  min-width: 200px;
  border: 1px solid #ccc;
  padding: 15px;
  border-radius: 8px;
  background-color: #f9f9f9;
  height: fit-content;
}
.product-grid {
  width: 80%;
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
}
  .product-card {
    width: calc(33.333% - 20px);
    border: 1px solid #ddd;
    padding: 15px;
    border-radius: 8px;
    text-align: center;
    position: relative;
  }
  .product-card img {
    max-width: 100%;
    height: auto;
    border-radius: 5px;
  }
  .wishlist-btn {
    position: absolute;
    top: 8px;
    right: 8px;
    background-color: rgba(237, 247, 247, 0.8);
    color: #fff;
    padding: 8px;
    border-radius: 50%;
    cursor: pointer;
  }
  .add-to-cart-btn {
    background-color: #3bcf0d;
    color: #fff;
    padding: 10px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    width: 100%;
    margin-top: 10px;
  }

  /* Filter form styling */
  form#filterForm {
    margin-bottom: 30px;
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    align-items: center;
  }
  form#filterForm input[type="text"],
  form#filterForm select,
  form#filterForm input[type="number"] {
    padding: 7px;
    border-radius: 4px;
    border: 1px solid #ccc;
  }
  form#filterForm button {
    background-color: #3bcf0d;
    color: white;
    padding: 8px 15px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }
    .active-page {
    font-weight: bold;
    text-decoration: underline;
  }
  nav.pagination-nav ul {
    list-style: none;
    display: flex;
    gap: 10px;
    padding-left: 0;
  }
  nav.pagination-nav ul li a {
    text-decoration: none;
    color: inherit;
  }
</style>

<div class="main-container">
  <h2>Farm Fresh Products</h2>

<div class="product-list-container">
  <!-- Left Sidebar -->
  <aside class="filter-sidebar">
    <form id="filterForm" method="get" action="/shop">
      <h3>Filters</h3>
      <input
        type="text"
        name="search"
        placeholder="Search products..."
        value="<%= typeof searchQuery !== 'undefined' ? searchQuery : '' %>"
      />

      <select name="category">
        <option value="">All Categories</option>
        <option value="fruits" <%= category === 'fruits' ? 'selected' : '' %>>Fruits</option>
        <option value="vegetables" <%= category === 'vegetables' ? 'selected' : '' %>>Vegetables</option>
        <option value="dairy" <%= category === 'dairy' ? 'selected' : '' %>>Dairy</option>
        <option value="other" <%= category === 'other' ? 'selected' : '' %>>Other</option>
      </select>

      <select name="sortBy">
        <option value="">Sort By</option>
        <option value="priceLow" <%= sortBy === 'priceLow' ? 'selected' : '' %>>Price: Low to High</option>
        <option value="priceHigh" <%= sortBy === 'priceHigh' ? 'selected' : '' %>>Price: High to Low</option>
        <option value="nameAsc" <%= sortBy === 'nameAsc' ? 'selected' : '' %>>Name: A to Z</option>
        <option value="nameDesc" <%= sortBy === 'nameDesc' ? 'selected' : '' %>>Name: Z to A</option>
      </select>

      <input
        type="number"
        name="minPrice"
        placeholder="Min Price"
        min="0"
        value="<%= typeof minPrice !== 'undefined' && minPrice !== 0 ? minPrice : '' %>"
      />

      <input
        type="number"
        name="maxPrice"
        placeholder="Max Price"
        min="0"
        value="<%= typeof maxPrice !== 'undefined' && maxPrice !== Number.MAX_SAFE_INTEGER ? maxPrice : '' %>"
      />

      <button type="submit">Apply</button>
      <button type="button" id="clearFiltersBtn">Clear</button>
    </form>
  </aside>

  <!-- Product Grid -->
  <main class="product-grid">
<% if (products && products.length > 0) { %>
  <% products.forEach(product => { 
       const cleanFileName = product.productImage[0].split('\\').pop().split('/').pop(); 
  %>
    <div class="product-card">
      <span class="wishlist-btn">❤️</span>
         <a href="/product-details?id=<%= product._id %>">
        <img src="/uploads/products/<%= cleanFileName %>" alt="<%= product.productName %>" />
        <h3><%= product.productName %></h3>
        <p>£<%= product.price %></p>
      </a>
       <button class="add-to-cart-btn">Add to Cart</button>
    </div>
  <% }); %>
<% } else { %>
  <p>No products found.</p>
<% } %>
</main> 




  <!-- Pagination -->
 <% if (totalPages && totalPages > 1) { %>
  <nav aria-label="Page navigation" class="pagination-nav" style="margin-top: 30px;">
    <ul>
      <% for (let i = 1; i <= totalPages; i++) { 
           // Build url with query params for page, search, category, sortBy, minPrice, maxPrice
           let url = `?page=${i}`;
           if (searchQuery) url += `&search=${encodeURIComponent(searchQuery)}`;
           if (category) url += `&category=${encodeURIComponent(category)}`;
           if (sortBy) url += `&sortBy=${encodeURIComponent(sortBy)}`;
           if (minPrice) url += `&minPrice=${minPrice}`;
           if (maxPrice && maxPrice !== Number.MAX_SAFE_INTEGER) url += `&maxPrice=${maxPrice}`;
      %>
        <li>
          <a href="<%= url %>" class="<%= i === currentPage ? 'active-page' : '' %>"><%= i %></a>
        </li>
      <% } %>
    </ul>
  </nav>
<% } %>

</div>

<script>
  // Clear button resets the filters and reloads the page without query params
  document.getElementById('clearFiltersBtn').addEventListener('click', () => {
    window.location.href = '/shop';
  });
</script>

<%- include("../../views/partials/user/footer") %>
